const Utils = (() => {

  // Keep references, but find elements after DOM is loaded
  let loadingIndicator = null;
  let errorIndicator = null;
  let errorMessageElement = null;

  function _initUtilsDOMReferences() {
      loadingIndicator = document.getElementById('loading-indicator');
      errorIndicator = document.getElementById('error-indicator');
      errorMessageElement = document.getElementById('error-message');
      // Attach listener here now that we know DOM should be ready
      listen('#error-indicator .close-button', 'click', hideError);
      if (!loadingIndicator || !errorIndicator || !errorMessageElement) {
          console.warn("Utils could not find all indicator elements on init.");
      }
  }


  function showLoadingIndicator(show, message = 'Loading...') {
    // Check if refs are initialized
    if (!loadingIndicator && show) {
        console.warn("Loading indicator not initialized, cannot show.");
        return;
    }
     if (!loadingIndicator) return; // Can't hide if not found

    loadingIndicator.querySelector('p').textContent = message;
    loadingIndicator.style.display = show ? 'flex' : 'none';
    if (show) {
        loadingIndicator.classList.add('active');
    } else {
         loadingIndicator.classList.remove('active');
    }
  }

  function showError(message = 'An unexpected error occurred.') {
    console.error("Error Shown:", message); // Log detailed error
     if (!errorIndicator || !errorMessageElement) {
        console.warn("Error indicator elements not initialized, using alert fallback.");
        alert(`Error: ${message}`);
        return;
     }
       errorMessageElement.textContent = message;
       errorIndicator.style.display = 'flex';
       errorIndicator.classList.add('active');
  }

  function hideError() {
     // Check if refs are initialized
     if (!errorIndicator) {
        console.warn("Error indicator not initialized, cannot hide.");
        return;
     }
        errorIndicator.style.display = 'none';
        errorIndicator.classList.remove('active');
  }

  // Basic UUID generator
  function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }

  // Fisher-Yates (Knuth) Shuffle
  function shuffleArray(array) {
    let currentIndex = array.length, randomIndex;
    while (currentIndex != 0) {
      randomIndex = Math.floor(Math.random() * currentIndex);
      currentIndex--;
      [array[currentIndex], array[randomIndex]] = [
        array[randomIndex], array[currentIndex]];
    }
    return array;
  }

   // Simple debounce function
   function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
   }

  // Add event listener safely
  function listen(selectorOrElement, eventName, callback) {
      const element = typeof selectorOrElement === 'string'
          ? document.querySelector(selectorOrElement)
          : selectorOrElement;
      if (element) {
          element.addEventListener(eventName, callback);
      } else {
          // Don't warn immediately, element might appear later.
          // console.warn(`Element not found for listener: ${selectorOrElement}`);
      }
  }


  return {
    initUtilsDOMReferences: _initUtilsDOMReferences, // Expose init function
    showLoadingIndicator,
    showError,
    hideError, // Allow closing error modal
    generateUUID,
    shuffleArray,
    debounce,
    listen
  };

})();