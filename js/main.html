// Global initialization function called from HTML body script tag
async function initializeApp(view, projectId = null) {
  console.log(`Initializing App - View: ${view}, ProjectID: ${projectId}`);
  
  try {
    // First initialize Utils since other components depend on it
    Utils.initUtilsDOMReferences();
    Utils.showLoadingIndicator(true, view === 'editor' ? 'Initializing Editor...' : 'Loading Training...');
    
    // Initialize core state module first
    StateManager.init(view === 'editor');
    
    if (view === 'editor') {
      // Initialize modules in correct dependency order
      CanvasController.initCanvas('editor-canvas', true); // Editor mode = true
      InteractionHandler.init(view);
      EditorUI.initEditorUI(); // Initialize editor UI after canvas
      
      // Apply sequence state to initial view
      InteractionHandler.applyInitialSequenceState();
      Utils.showLoadingIndicator(false);
      console.log("Editor Initialized.");
    } else if (view === 'viewer' && projectId) {
      // Initialize core viewer components
      CanvasController.initCanvas('viewer-canvas', false);
      InteractionHandler.init(view);
      
      try {
        // Load project data - using try/catch for better error handling
        Utils.showLoadingIndicator(true, 'Loading Project...');
        const jsonString = await ServerClient.loadProject(projectId);
        
        if (StateManager.loadProjectData(jsonString)) {
          // Project loaded successfully
          CanvasController.loadSlide(StateManager.getCurrentSlide());
          
          // Setup sequence navigation AFTER slide load
          InteractionHandler.applyInitialSequenceState();
          console.log("Viewer Initialized and Project Loaded.");
        } else {
          throw new Error("Failed to load project data");
        }
      } catch (error) {
        console.error("Project loading failed:", error);
        Utils.showError(`Failed to load project: ${error.message}`);
        throw error; // Re-throw to be caught by outer catch
      } finally {
        Utils.showLoadingIndicator(false);
      }
    } else if (view === 'viewer') {
      throw new Error("Project ID is missing for viewer mode");
    } else {
      throw new Error(`Unknown application view: ${view}`);
    }
  } catch (error) {
    console.error("Initialization failed:", error);
    Utils.showError(`Failed to initialize application: ${error.message}`);
    Utils.showLoadingIndicator(false);
    
    // Show error page for serious initialization errors
    document.body.innerHTML = `<div class="error-page">
      <h1>Initialization Error</h1>
      <p>${error.message}</p>
    </div>`;
  }
}

// Optional: Add beforeunload listener for editor to warn about unsaved changes
window.addEventListener('beforeunload', (event) => {
    // Check if the current view is 'editor' (this requires a way to know the view mode globally)
    // A simple check: presence of editor-specific elements
    const isEditorView = !!document.getElementById('editor-canvas');

    if (isEditorView && StateManager.isDirty()) {
        const confirmationMessage = 'You have unsaved changes. Are you sure you want to leave?';
        event.returnValue = confirmationMessage; // Standard for most browsers
        return confirmationMessage; // For older browsers
    }
});