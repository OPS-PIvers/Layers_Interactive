<script>
    // Ensure proper initialization order
    document.addEventListener('DOMContentLoaded', () => {
        let initAttempts = 0;
        const maxAttempts = 5;
        
        function initializeApp(mode, projectId) {
            try {
                console.log(`Initializing app in ${mode || 'default'} mode${projectId ? ' with project: ' + projectId : ''}`);
                
                // First ensure all core modules are available
                if (typeof StateManager === 'undefined' || 
                    typeof Utils === 'undefined' ||
                    typeof CanvasController === 'undefined') {
                    throw new Error('Core modules not loaded yet. Retrying...');
                }
                
                // Initialize state management first
                StateManager.init(mode === 'editor');
                
                // Different initialization for editor vs. viewer mode
                if (mode === 'editor') {
                    console.log("Initializing editor components");
                    
                    // Make sure we have the canvas element
                    const editorCanvas = document.getElementById('editor-canvas');
                    if (!editorCanvas) {
                        throw new Error('Editor canvas element not found');
                    }
                    
                    // Initialize canvas controller
                    CanvasController.initCanvas('editor-canvas', true);
                    
                    // Initialize UI components
                    if (typeof EditorUI !== 'undefined' && typeof EditorUI.initEditorUI === 'function') {
                        EditorUI.initEditorUI();
                    } else {
                        throw new Error('EditorUI module not properly loaded');
                    }
                    
                    // Initialize other editor components if needed
                    if (typeof FontLoader !== 'undefined' && typeof FontLoader.init === 'function') {
                        FontLoader.init();
                    }
                    
                    if (typeof InteractionHandler !== 'undefined' && typeof InteractionHandler.init === 'function') {
                        InteractionHandler.init('editor');
                    }
                    
                    // Initialize ImageManager for image uploading
                    if (typeof ImageManager !== 'undefined' && typeof ImageManager.init === 'function') {
                        ImageManager.init();
                    }
                    
                } else if (mode === 'viewer') {
                    console.log("Initializing viewer components");
                    
                    // Make sure we have the canvas element
                    const viewerCanvas = document.getElementById('viewer-canvas');
                    if (!viewerCanvas) {
                        throw new Error('Viewer canvas element not found');
                    }
                    
                    // Initialize canvas controller
                    CanvasController.initCanvas('viewer-canvas', false);
                    
                    // Initialize interaction handler for viewer mode
                    if (typeof InteractionHandler !== 'undefined') {
                        InteractionHandler.init('viewer');
                    }
                    
                    // Load project if projectId is provided
                    if (projectId) {
                        loadViewerProject(projectId);
                    }
                } else {
                    throw new Error("Could not determine application mode");
                }
                
                console.log('Application initialized successfully');
                
            } catch (error) {
                console.error('Initialization error:', error);
                initAttempts++;
                
                if (initAttempts < maxAttempts) {
                    console.log(`Retrying initialization in 100ms (attempt ${initAttempts}/${maxAttempts})`);
                    setTimeout(() => initializeApp(mode, projectId), 100);
                } else {
                    // Use the proper error function if available
                    if (typeof Utils !== 'undefined' && typeof Utils.showError === 'function') {
                        Utils.showError('Failed to initialize application after multiple attempts. Please refresh the page.');
                    } else {
                        alert('Failed to initialize application. Please refresh the page.');
                    }
                }
            }
        }
    
        // Function to load a project for the viewer
        async function loadViewerProject(projectId) {
            console.log("Loading project for viewer:", projectId);
            
            try {
                // Show loading indicator if Utils is available
                if (typeof Utils !== 'undefined') {
                    Utils.showLoadingIndicator(true, 'Loading Project...');
                }
                
                // Load project data
                const jsonString = await ServerClient.loadProject(projectId);
                
                if (StateManager.loadProjectData(jsonString)) {
                    // Load the first slide
                    const slide = StateManager.getCurrentSlide();
                    if (slide) {
                        CanvasController.loadSlide(slide);
                        console.log("Project loaded successfully in viewer mode");
                        
                        // Set up sequence if available
                        if (typeof InteractionHandler !== 'undefined') {
                            if (typeof InteractionHandler.applyInitialSequenceState === 'function') {
                                InteractionHandler.applyInitialSequenceState();
                            } else if (typeof InteractionHandler.setupSequence === 'function') {
                                InteractionHandler.setupSequence();
                            }
                        }
                    }
                } else {
                    throw new Error("Failed to load project data");
                }
            } catch (error) {
                console.error("Failed to load project:", error);
                
                if (typeof Utils !== 'undefined') {
                    Utils.showError(`Failed to load project: ${error.message}`);
                } else {
                    alert(`Failed to load project: ${error.message}`);
                }
            } finally {
                // Hide loading indicator
                if (typeof Utils !== 'undefined') {
                    Utils.showLoadingIndicator(false);
                }
            }
        }
    
        // Make initialization function available globally
        window.initializeApp = initializeApp;
    });
    
    // Add beforeunload listener to warn about unsaved changes
    window.addEventListener('beforeunload', (event) => {
        // Check if in editor mode and has unsaved changes
        const isEditorView = !!document.getElementById('editor-canvas');
        
        if (isEditorView && 
            typeof StateManager !== 'undefined' && 
            typeof StateManager.isDirty === 'function' && 
            StateManager.isDirty()) {
            
            const confirmationMessage = 'You have unsaved changes. Are you sure you want to leave?';
            event.returnValue = confirmationMessage; // Standard for most browsers
            return confirmationMessage; // For older browsers
        }
    });
</script>