<script>
  /**
   * Client for server-side API calls
   */
  const ServerClient = (() => {
    /**
     * Run a server function asynchronously
     * @param {string} functionName - Server function name
     * @param {...*} args - Function arguments
     * @return {Promise} Promise resolving to function result
     */
    function runAsync(functionName, ...args) {
      return new Promise((resolve, reject) => {
        Utils.showLoadingIndicator(true, `Processing ${functionName}...`);
        
        google.script.run
          .withSuccessHandler(result => {
            Utils.showLoadingIndicator(false);
            resolve(result);
          })
          .withFailureHandler(error => {
            Utils.showLoadingIndicator(false);
            console.error(`Error in ${functionName}:`, error);
            reject(error);
          })
          [functionName](...args);
      });
    }
    
    /**
     * Save project data
     * @param {string} jsonString - Project data as JSON string
     * @param {string} projectId - Project ID (if updating)
     * @param {string} title - Project title
     * @return {Promise} Promise resolving to save result
     */
    function saveProject(jsonString, projectId, title) {
      return runAsync('saveProjectData', jsonString, projectId, title);
    }
    
    /**
     * Load project data
     * @param {string} projectId - Project ID
     * @return {Promise} Promise resolving to project JSON string
     */
    function loadProject(projectId) {
      return runAsync('loadProjectData', projectId);
    }
    
    /**
     * Upload an image
     * @param {string} dataUrl - Image data URL
     * @param {string} filename - Image filename
     * @return {Promise} Promise resolving to upload result
     */
    function uploadImage(dataUrl, filename) {
      return runAsync('saveImageFile', dataUrl, filename);
    }
    
    /**
     * Load an image
     * @param {string} fileId - Image file ID
     * @return {Promise} Promise resolving to image data URL
     */
    function loadImage(fileId) {
      return runAsync('getImageDataUrl', fileId);
    }
    
    /**
     * Upload an audio file
     * @param {string} dataUrl - Audio data URL
     * @param {string} filename - Audio filename
     * @return {Promise} Promise resolving to upload result
     */
    function uploadAudio(dataUrl, filename) {
      return runAsync('saveAudioFile', dataUrl, filename);
    }
    
    /**
     * Load an audio file
     * @param {string} fileId - Audio file ID
     * @return {Promise} Promise resolving to audio data URL
     */
    function loadAudio(fileId) {
      return runAsync('getAudioDataUrl', fileId);
    }
    
    /**
     * Send quiz results to user
     * @param {Object} results - Quiz results
     * @param {string} userEmail - User email
     * @return {Promise} Promise resolving to send result
     */
    function sendQuizToUser(results, userEmail) {
      return runAsync('sendQuizResultsToUser', results, userEmail);
    }
    
    /**
     * Send quiz results to creator
     * @param {Object} results - Quiz results
     * @param {string} creatorEmail - Creator email
     * @return {Promise} Promise resolving to send result
     */
    function sendQuizToCreator(results, creatorEmail) {
      return runAsync('sendQuizResultsToCreator', results, creatorEmail);
    }
    
    // Public API
    return {
      saveProject,
      loadProject,
      uploadImage,
      loadImage,
      uploadAudio,
      loadAudio,
      sendQuizToUser,
      sendQuizToCreator
    };
  })();
  </script>