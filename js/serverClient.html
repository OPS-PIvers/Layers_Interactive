<script>
const ServerClient = (() => {

  function runAsync(functionName, ...args) {
    return new Promise((resolve, reject) => {
      try {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(error => {
             console.error(`Server call failed for ${functionName}:`, error);
             // Try to extract a meaningful message
             const message = error.message || 
                            (typeof error === 'string' ? error : 'An unknown server error occurred.');
             reject(new Error(message)); // Reject with an Error object
          })
          [functionName](...args);
      } catch (error) {
        console.error(`Error calling server function ${functionName}:`, error);
        reject(new Error(`Failed to call server function: ${error.message}`));
      }
    });
  }

  return {
    saveProject(projectJsonString, projectId, title) {
      if (!projectJsonString) {
        return Promise.reject(new Error("Project data cannot be empty"));
      }
      
      Utils.showLoadingIndicator(true, 'Saving Project...');
      return runAsync('saveProjectData', projectJsonString, projectId, title)
          .finally(() => Utils.showLoadingIndicator(false));
    },
    
    loadProject(projectId) {
      if (!projectId || typeof projectId !== 'string') {
        return Promise.reject(new Error("Invalid project ID"));
      }
      
      Utils.showLoadingIndicator(true, 'Loading Project...');
      return runAsync('loadProjectData', projectId)
          .finally(() => Utils.showLoadingIndicator(false));
    },
    
    listProjects() {
        Utils.showLoadingIndicator(true, 'Loading Project List...');
        return runAsync('listProjects')
            .finally(() => Utils.showLoadingIndicator(false));
    },
    
    uploadImage(dataUrl, filename) {
      if (!dataUrl || !dataUrl.startsWith('data:image')) {
        return Promise.reject(new Error("Invalid image data"));
      }
      
      Utils.showLoadingIndicator(true, 'Uploading Image...');
      return runAsync('saveImageFile', dataUrl, filename)
          .finally(() => Utils.showLoadingIndicator(false));
    },
    
    loadImage(fileId) {
      if (!fileId) {
        return Promise.reject(new Error("Invalid file ID"));
      }
      
      // Don't show loading for this as it's often background
      return runAsync('getImageDataUrl', fileId);
    },
    
    sendQuizToUser(resultsPayload, userEmail) {
      if (!resultsPayload || !userEmail) {
        return Promise.reject(new Error("Missing required parameters"));
      }
      
      Utils.showLoadingIndicator(true, 'Sending Results...');
      return runAsync('sendQuizResultsToUser', resultsPayload, userEmail)
          .finally(() => Utils.showLoadingIndicator(false));
    },
    
    sendQuizToCreator(resultsPayload, creatorEmail) {
      if (!resultsPayload || !creatorEmail) {
        return Promise.reject(new Error("Missing required parameters"));
      }
      
      Utils.showLoadingIndicator(true, 'Sending Results...');
      return runAsync('sendQuizResultsToCreator', resultsPayload, creatorEmail)
          .finally(() => Utils.showLoadingIndicator(false));
    }
  };
})();
</script>